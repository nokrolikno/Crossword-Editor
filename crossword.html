<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Конструктор кроссвордов</title>
<style>
  body {
    font-family: Inter, Tahoma, Arial, sans-serif;
    background: #f5f6f8;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    color: #111;
  }

  h1 { margin: 0 0 12px 0; font-size: 20px; }
  #setup { margin-bottom: 12px; }

  #grid-container {
    position: relative;
    display: inline-block;
    margin: 40px 0;
  }

  #grid {
    display: grid;
    background: #fff;
    padding: 10px;
    border: 2px solid #000;
  }

  .cell {
    width: 40px;
    height: 40px;
    box-sizing: border-box;
    position: relative;
    display: flex;
    align-items: stretch;
    justify-content: stretch;
    background: transparent;
    user-select: none;
    border: 1px solid #ccc;
    transition: border-color 0.1s ease;
  }

  .cell input {
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
    padding: 0;
    margin: 0;
    text-align: center;
    font-weight: 600;
    line-height: 1;
    caret-color: #000;
    outline: none;
  }

  .cell .letter {
    position: absolute;
    inset: 0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 18px;
    pointer-events: none;
    color: #000;
  }

  .word-cell {
    border: 2px solid #000 !important;
    background: #fff;
  }

  #controls { display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap: wrap; }
  input[type="number"] { width:64px; padding:6px; }
  button {
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    background: #1976d2;
    color: white;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #1565c0; }
  button.secondary { background: #6c757d; }
  button.gray { background: #888; }

  .plus-minus-btn {
    background: #e0e0e0;
    border: 1px solid #ccc;
    border-radius: 50%;
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: absolute;
    transition: background 0.2s, transform 0.1s;
  }
  .plus-minus-btn:hover {
    background: #d5d5d5;
    transform: scale(1.1);
  }

  .plus-minus-btn img {
    width: 18px;
    height: 18px;
  }

  /* Расположение кнопок вокруг кроссворда */
  #btn-top-plus { top: -40px; left: 50%; transform: translateX(-50%); }
  #btn-top-minus { top: -40px; left: calc(50% + 40px); transform: translateX(-50%); }

  #btn-bottom-plus { bottom: -40px; left: 50%; transform: translateX(-50%); }
  #btn-bottom-minus { bottom: -40px; left: calc(50% + 40px); transform: translateX(-50%); }

  #btn-left-plus { left: -40px; top: 50%; transform: translateY(-50%); }
  #btn-left-minus { left: -40px; top: calc(50% + 40px); transform: translateY(-50%); }

  #btn-right-plus { right: -40px; top: 50%; transform: translateY(-50%); }
  #btn-right-minus { right: -40px; top: calc(50% + 40px); transform: translateY(-50%); }

  #footer-options { margin-top:10px; }
</style>
</head>
<body>
<h1>Конструктор кроссвордов</h1>

<div id="setup">
  <label>Размер поля:</label>
  <input id="rows" type="number" min="1" max="40" placeholder="Строки" value="10">
  ×
  <input id="cols" type="number" min="1" max="40" placeholder="Столбцы" value="10">
  <button id="create">Создать</button>
  <div id="controls" style="display:inline-flex">
    <button id="clear" class="secondary">Очистить содержимое</button>
    <button id="save-png">Сохранить как PNG</button>
    <button id="save-cross" class="gray">Сохранить .cross</button>
    <button id="load-cross" class="gray">Загрузить .cross</button>
  </div>
</div>

<div id="grid-container">
  <div id="grid"></div>

  <!-- Кнопки добавления и удаления строк/столбцов -->
  <button class="plus-minus-btn" id="btn-top-plus"><img src="src/plus.png"></button>
  <button class="plus-minus-btn" id="btn-top-minus"><img src="src/minus.png"></button>

  <button class="plus-minus-btn" id="btn-bottom-plus"><img src="src/plus.png"></button>
  <button class="plus-minus-btn" id="btn-bottom-minus"><img src="src/minus.png"></button>

  <button class="plus-minus-btn" id="btn-left-plus"><img src="src/plus.png"></button>
  <button class="plus-minus-btn" id="btn-left-minus"><img src="src/minus.png"></button>

  <button class="plus-minus-btn" id="btn-right-plus"><img src="src/plus.png"></button>
  <button class="plus-minus-btn" id="btn-right-minus"><img src="src/minus.png"></button>
</div>

<div id="footer-options">
  <label><input type="checkbox" id="include-link" checked> Оставить ссылку на ресурс</label>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const grid = document.getElementById('grid');
const createBtn = document.getElementById('create');
const savePngBtn = document.getElementById('save-png');
const saveCrossBtn = document.getElementById('save-cross');
const loadCrossBtn = document.getElementById('load-cross');
const clearBtn = document.getElementById('clear');
const includeLinkCheckbox = document.getElementById('include-link');

let rows = 0, cols = 0;

createBtn.addEventListener('click', () => {
  rows = parseInt(document.getElementById('rows').value, 10) || 0;
  cols = parseInt(document.getElementById('cols').value, 10) || 0;
  if (rows <= 0 || cols <= 0) { alert('Введите корректные размеры'); return; }
  buildGrid(rows, cols);
});

clearBtn.addEventListener('click', () => {
  grid.querySelectorAll('.cell-input').forEach(inp => inp.value = '');
  grid.querySelectorAll('.cell').forEach(c => c.classList.remove('word-cell'));
  grid.querySelectorAll('.letter').forEach(l => l.textContent = '');
});

function buildGrid(r, c, prevCells = []) {
  grid.innerHTML = '';
  rows = r;
  cols = c;
  grid.style.gridTemplateRows = `repeat(${r}, 40px)`;
  grid.style.gridTemplateColumns = `repeat(${c}, 40px)`;

  for (let i = 0; i < r * c; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    const letterEl = document.createElement('div');
    letterEl.className = 'letter';
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.maxLength = 4;
    input.autocomplete = 'off';

    input.addEventListener('input', () => {
      const val = input.value.trim();
      const hasLetter = /[A-Za-zА-Яа-яЁё]/.test(val);
      const hasDigit = /^\d+$/.test(val);

      if (hasLetter) {
        const firstLetterMatch = val.match(/[A-Za-zА-Яа-яЁё]/);
        letterEl.textContent = firstLetterMatch ? firstLetterMatch[0].toUpperCase() : '';
        cell.classList.add('word-cell');
        input.style.fontSize = '0px';
      } else if (hasDigit && val.length > 0) {
        letterEl.textContent = val;
        cell.classList.remove('word-cell');
        input.style.fontSize = '0px';
      } else {
        letterEl.textContent = '';
        cell.classList.remove('word-cell');
        input.style.fontSize = '18px';
      }
    });

    input.addEventListener('focus', () => { input.style.background = '#fff5b1'; });
    input.addEventListener('blur', () => { input.style.background = 'transparent'; input.dispatchEvent(new Event('input')); });

    cell.appendChild(letterEl);
    cell.appendChild(input);
    grid.appendChild(cell);

    if (prevCells[i]) {
      input.value = prevCells[i];
      input.dispatchEvent(new Event('input'));
    }
  }
}

// Сохранение текущего состояния
function saveCurrentState() {
  return Array.from(grid.querySelectorAll('.cell .letter')).map(l => l.textContent);
}

// Функция обновления сетки с разным типом добавления
function updateGrid(newRows, newCols, mode) {
  const oldData = saveCurrentState();
  const newData = [];

  if (mode === 'add-top') {
    for (let c = 0; c < cols; c++) newData.push('');
  }

  for (let r = 0; r < rows; r++) {
    let row = [];
    for (let c = 0; c < cols; c++) row.push(oldData[r * cols + c] || '');

    if (mode === 'add-left') row.unshift('');
    if (mode === 'add-right') row.push('');
    newData.push(...row);

    if (mode === 'add-bottom' && r === rows - 1) {
      for (let c = 0; c < cols; c++) newData.push('');
    }
  }

  if (mode === 'remove-top') oldData.splice(0, cols);
  if (mode === 'remove-bottom') oldData.splice(-cols);
  if (mode === 'remove-left' || mode === 'remove-right') {
    for (let r = 0; r < rows; r++) {
      if (mode === 'remove-left') oldData.splice(r * (cols - 1), 1);
      else oldData.splice(r * cols + (cols - 1 - r), 1);
    }
  }

  const finalData = (mode.startsWith('remove')) ? oldData : newData;

  buildGrid(newRows, newCols, finalData);
  document.getElementById('rows').value = newRows;
  document.getElementById('cols').value = newCols;
}

// Привязка кнопок
document.getElementById('btn-top-plus').onclick = () => updateGrid(rows + 1, cols, 'add-top');
document.getElementById('btn-bottom-plus').onclick = () => updateGrid(rows + 1, cols, 'add-bottom');
document.getElementById('btn-left-plus').onclick = () => updateGrid(rows, cols + 1, 'add-left');
document.getElementById('btn-right-plus').onclick = () => updateGrid(rows, cols + 1, 'add-right');

document.getElementById('btn-top-minus').onclick = () => { if (rows > 1) updateGrid(rows - 1, cols, 'remove-top'); };
document.getElementById('btn-bottom-minus').onclick = () => { if (rows > 1) updateGrid(rows - 1, cols, 'remove-bottom'); };
document.getElementById('btn-left-minus').onclick = () => { if (cols > 1) updateGrid(rows, cols - 1, 'remove-left'); };
document.getElementById('btn-right-minus').onclick = () => { if (cols > 1) updateGrid(rows, cols - 1, 'remove-right'); };

// Сохранение PNG
savePngBtn.addEventListener('click', async () => {
  const emptyCells = Array.from(grid.querySelectorAll('.cell:not(.word-cell)'));
  emptyCells.forEach(cell => cell.style.borderColor = 'transparent');

  const tempContainer = document.createElement('div');
  tempContainer.style.background = '#fff';
  tempContainer.style.display = 'inline-block';
  tempContainer.style.padding = '10px';

  const gridClone = grid.cloneNode(true);
  gridClone.style.border = 'none';
  tempContainer.appendChild(gridClone);

  if (includeLinkCheckbox.checked) {
    const footer = document.createElement('div');
    footer.style.width = '100%';
    footer.style.textAlign = 'center';
    footer.style.fontSize = '14px';
    footer.style.fontFamily = 'Arial';
    footer.style.marginTop = '10px';
    footer.style.background = '#fff';
    footer.style.border = 'none';
    footer.textContent = 'Выполнено с помощью ресурса https://github.com/nokrolikno/Crossword-Editor';
    tempContainer.appendChild(footer);
  }

  document.body.appendChild(tempContainer);
  try {
    const canvas = await html2canvas(tempContainer, { scale: 3, backgroundColor: '#ffffff' });
    const link = document.createElement('a');
    link.download = 'crossword.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  } finally {
    emptyCells.forEach(cell => cell.style.borderColor = '#ccc');
    tempContainer.remove();
  }
});

// Сохранение и загрузка .cross
saveCrossBtn.addEventListener('click', () => {
  const cells = Array.from(grid.querySelectorAll('.cell'));
  const data = {
    rows,
    cols,
    cells: cells.map(cell => cell.querySelector('.letter').textContent.trim() || '')
  };
  const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
  const link = document.createElement('a');
  link.download = 'crossword.cross';
  link.href = URL.createObjectURL(blob);
  link.click();
  URL.revokeObjectURL(link.href);
});

loadCrossBtn.addEventListener('click', () => {
  const inputFile = document.createElement('input');
  inputFile.type = 'file';
  inputFile.accept = '.cross';
  inputFile.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!data.rows || !data.cols || !data.cells) throw new Error('Неверный формат файла');
        document.getElementById('rows').value = data.rows;
        document.getElementById('cols').value = data.cols;
        buildGrid(data.rows, data.cols, data.cells);
      } catch (err) {
        alert('Ошибка загрузки: ' + err);
      }
    };
    reader.readAsText(file);
  });
  inputFile.click();
});

document.addEventListener('DOMContentLoaded', () => {
  buildGrid(10, 10);
});
</script>
</body>
</html>
